:root{
  --left-nvbr-hgt: 0px;
  --left-bmbr-hgt: 0px;
}

:root{
  --hidden-left: calc( 0px - var(--sdbr-wdt) + var(--margin-on-left) );
  --semi-hidden-left: calc( 0px - var(--sdbr-wdt) + var(--sdbr-tb-wdt) );
  
  --hover-left: calc( var(--left-margin) + var(--margin) );
  
  --left-bmbr-gap: 0px;
  --left-sdbr-gap: 0px;
  --left-gap: calc( var(--margin) / 2 );
}

:root:not([titlepreface*="᠎"]){
  &:not( :has( #sidebar-main[hidden] )
  ) { --left-margin: var(--sdbr-tb-wdt); }
  
  &:has(
    #sidebar-box:not([hidden]),
    #sidebar-main:not([hidden]) > *[expanded]
  ) { --left-margin: var(--sdbr-wdt); }
}

/* 

##############################################################################################################################

 S I D E B A R

*/

/* hide ugly animation */
.sidebar-animation-screenshot {visibility: collapse !important;}

/* new sidebar panel */
.wrapper:has(.tools-and-extensions) {
  background: transparent !important;
  color: var(--bg-txt) !important;
  border: 0px solid transparent !important;
  
  padding: 0px !important;
  padding-bottom: calc( var(--margin) / 1.5 ) !important;
  
  &:has(.expanded-button) { padding-inline: var(--toolbar-start-end-padding) !important; }
  
  min-width: 0px !important;
  .tools-and-extensions, .bottom-actions { padding-inline: 0px !important }
  
  :is(.tools-and-extensions, .bottom-actions) moz-button { margin-block-start: 4px !important; }
}


/* tabs */
#vertical-tabs {
  width: 100% !important;
  
  .tabbrowser-tab{
    max-width: none !important;
    padding: 0px !important;
    
    .tab-background{ border-radius: var(--tab-border-radius) !important; }
    
    &:not([pinned], [fadein]) { visibility: collapse !important; }
  }
  
  .tab-background:is([selected], [multiselected])
  { background-color: color-mix(in srgb, currentColor 20%, transparent) !important; }
  
  .tabbrowser-tab[pinned] .tab-background:not( :is([selected], [multiselected]) )
  { background-color: color-mix(in srgb, currentColor 10%, transparent) !important; }
  
  #tabbrowser-tabs:not([expanded]){
    #newtab-button-container, #tabs-newtab-button, .tabbrowser-tab, 
    .tabbrowser-tab[pinned] :is(.tab-background, .tab-content)
    { width: calc( var(--sdbr-tb-wdt) - 8px ) !important; }
    
    #newtab-button-container{ padding-inline: 4px !important; }
    #tabs-newtab-button, .tabbrowser-tab{ margin-inline: 4px !important; }
  }
  
  #tabbrowser-tabs{ grid-gap: 0px !important; }
  #vertical-pinned-tabs-container:has(tab){ margin-block: var(--space-small) !important; }
  
  .tabbrowser-tab:not([pinned]) .tab-background{
    margin: 4px 0px !important;
    height: 32px !important;
    min-height: 32px !important;
  }
}


/* pinned tabs */
#vertical-tabs #tabbrowser-tabs[expanded] #vertical-pinned-tabs-container{
  padding-inline: 0px !important;
  display: flex !important;
  flex-wrap: wrap;
  flex-direction: row;
  
  --grid-gap: 5px;
  width: calc( 100% + var(--grid-gap) ) !important;
  grid-gap: var(--grid-gap) !important;
  
  .tabbrowser-tab[pinned]{
    --wm: 3; --hm: 1; min-width: 0px !important;
    width: calc( 100% / var(--wm) - var(--grid-gap) ) !important;
    height: calc( var(--sdbr-wdt) / 4.6 / var(--hm) ) !important;
  }
  
  .tabbrowser-tab[pinned]:nth-child(1):last-child
    {--wm: 1; --hm: 1.4;}
  
  &:has(.tabbrowser-tab:nth-child(3n + 2):last-child)
    .tabbrowser-tab:nth-last-child(-n + 2)
      {--wm: 2; --hm: 1.2;}
  
  &:has(.tabbrowser-tab:nth-child(3n + 4):last-child)
    .tabbrowser-tab:nth-last-child(-n + 4)
      {--wm: 4; --hm: 1.3;}
  
  .tabbrowser-tab[pinned] .tab-background{
    margin: 0px !important;
    border-radius: var(--big-rounding) !important;
  }
  
  .tab-icon-image, .tab-icon-stack{
    height: var(--pinned-tab-icon-size) !important;
    width: var(--pinned-tab-icon-size) !important;
  }
}


/* new tab buttons */
#vertical-tabs{
  #tabbrowser-arrowscrollbox[overflowing="true"] {
    border-top: 1px solid color-mix(in srgb, currentColor 25%, transparent);
    padding-block: 5px !important;
  }
  
  #tabs-newtab-button{
    display: flex !important;
    appearance: none !important;

    border-radius: var(--button-border-radius) !important;
    &:hover { background: var(--tab-hover-background-color) !important; }

    height: 36px !important;
    width: 100% !important;

    .toolbarbutton-icon {
      width: 100% !important;
      height: 16px !important;
      padding: 0 calc( 50% - 8px );
    }
  }

  #vertical-tabs-newtab-button{
    appearance: none !important;
    border-radius: var(--rounding) !important;
  }
  
  #newtab-button-container{
    display: none !important; /* */
    margin-inline-end: 0px !important;
  }
}


/* sidebar */
#sidebar-splitter{ display: none !important; }

#sidebar-box, #sidebar-main{
  position: fixed !important;
  min-width: 0px !important;
  padding: 0px !important;
}

#sidebar-main{
  --sidebar-text-color: var(--bg-txt) !important;
  
  top: calc( var(--left-nvbr-hgt) + var(--left-bmbr-hgt) );
  bottom: 0px;
  left: 0px;
  
  transition: var(--bar-transition) !important;
  z-index: 2 !important;
}

#sidebar-box{
  top: calc( var(--left-nvbr-hgt) + var(--left-bmbr-hgt) + var(--margin) );
  
  @media (-moz-bool-pref: "shyfox.position.navbar"), (-moz-bool-pref: "shyfox.position.bookmarkbar") 
  { top: calc( var(--left-nvbr-hgt) + var(--left-bmbr-hgt) ); }
  
  bottom: var(--margin);
  
  z-index: 1 !important;
  width: calc( var(--sdbr-wdt) - var(--sdbr-tb-wdt) - var(--margin) / 2 ) !important;
  margin-left: var(--sdbr-tb-wdt);
  left: 0px;
  
  border-radius: var(--big-rounding) !important;
  transition: var(--bar-transition), var(--opacity-transition), width var(--long-trans-dur) ease !important;
}

#sidebar-box[hidden]{
  display: flex !important;
  opacity: 0 !important;
  pointer-events: none !important;
  left: calc( 0px - var(--sdbr-wdt) ) !important;
}

#sidebar{
  border: var(--border) !important;
  border-radius: var(--big-rounding) !important;
  box-shadow: none !important;
}


/* old sidebar */
:root:has(#sidebar-main > *[hidden]) #sidebar-box:not([hidden]) {
  width: calc( var(--sdbr-wdt) - var(--margin) ) !important;
  margin-left: calc( var(--margin) / 2 ) !important;
}

#sidebar-box{  
  #sidebar-header{
    border: none !important;
    padding: 4px 3px !important;
  }
  #sidebar-close{
    margin-inline: 4px !important;
    padding: 7px !important;
    width: 30px !important;
    border-radius: var(--rounding) !important;
  }
}


/* width */
#sidebar-main > *:not([expanded]){
  width: var(--sdbr-tb-wdt) !important;
}

#sidebar-main > *[expanded]{
  width: var(--sdbr-wdt) !important;
}

:root:has( #sidebar-main > *[expanded]:not([hidden]) ){
  #sidebar-box{ filter: blur(5px) grayscale(80%) !important; }
  #sidebar { border: 0px solid transparent !important; }
}

:root[titlepreface*="᠎"]{
  #sidebar-box, #sidebar-main{
    left: var(--hidden-left) !important;
  }
  
  &:has(#sidebar-box[hidden]):has( #sidebar-main > *:not([hidden]):not([expanded]) ) 
  #sidebar-main{ left: calc( 0px - var(--sdbr-tb-wdt) + var(--margin-on-left) ) !important; }
}

/* 

##############################################################################################################################

 N A V B A R

*/

@media (-moz-bool-pref: "shyfox.position.navbar") {
  :root{
    --left-nvbr-hgt: calc(var(--nvbr-hgt) * 2);
  }
  
  #nav-bar{
    overflow: visible !important;

    left: 0;
    top: 0;
    width: var(--sdbr-wdt) !important;
    
    padding-bottom: var(--nvbr-hgt) !important;
    height: calc(var(--nvbr-hgt) * 2) !important;
  }
  
  #nav-bar toolbarspring{ max-width: unset !important; }
  
  #nav-bar-customization-target{ margin-left: calc( 0px - var(--br-wdt) ) }
  
  #urlbar-container{
    width: calc( var(--sdbr-wdt) - var(--toolbar-start-end-padding) * 2 ) !important;
    height: var(--nvbr-hgt) !important;
    
    margin: 0 !important;
    margin-left: var(--toolbar-start-end-padding) !important;
    
    position: absolute !important;
    bottom: 0;
    
    .urlbar-page-action{ visibility: collapse !important; }
    #pageActionButton[multiple-children]{ visibility: visible !important; }
    
    #identity-icon-box #identity-icon-label { display: none !important; }
    
    #identity-box[pageproxystate="invalid"]{
      #identity-icon-box { padding: 0.5px !important; }
      #identity-icon { display: none !important; }
    }
  }
    
  #urlbar[breakout-extend]{
    #urlbar-background{
      border-radius: 0 !important;
      border-left: none !important;
      border-right: none !important;
    }
    
    width: var(--sdbr-wdt) !important;
    left: calc( 0px - var(--toolbar-start-end-padding)) !important;
    right: 0 !important;
  }
  
  :is(:root[titlepreface*="᠎"], :root:not([titlepreface*="᠎"]):has( #sidebar-main > *:not([hidden]):not([expanded]) ):has( #sidebar-box[hidden] ) ) {
    #nav-bar{
      --nvbr-hover-top: calc( var(--margin-on-top) + var(--margin) );
      
      --nvbr-hover-col: var(--tb-col);
      --nvbr-hover-txt: var(--tb-txt);
      
      --nvbr-hover-brs: var(--big-rounding);
      --nvbr-hover-brw: var(--br-wdt);
      --nvbr-hover-brt: var(--br-style);
      --nvbr-hover-brc: var(--br-col);
    }
    
    #nav-bar-customization-target::before{
      content: ""; position: absolute;
      -moz-window-dragging: drag;
      z-index: -999;
      right: calc( 0px - var(--panel-hidden-hitbox) );
      bottom: calc( 0px - var(--br-wdt) );
      width: 500%; height: 500%;
      background: var(--debug-col);
    }
    
    #urlbar[breakout-extend]{
      #urlbar-background{
        border-radius: var(--big-rounding) !important;
        border: var(--border) !important;
      }
    }
  }
  
  :root[titlepreface*="᠎"]{
    #nav-bar{
      left: var(--hidden-left) !important;
    }
  }
  
  :root:not([titlepreface*="᠎"]):has( #sidebar-main > *:not([hidden]):not([expanded]) ):has( #sidebar-box[hidden] ) {
    #nav-bar{
      left: var(--semi-hidden-left) !important;
    }
  }
  
}

/* 

##############################################################################################################################

 B O O K M A R K S   B A R

*/

@media (-moz-bool-pref: "shyfox.position.bookmarkbar") {
  :root{
    --bmbr-hgt: 40px;
    --left-bmbr-hgt: var(--bmbr-hgt);
  }
  
  #PersonalToolbar{
    left: 0;
    top: var(--left-nvbr-hgt);

    width: var(--sdbr-wdt) !important;
    overflow: visible !important;
  }
  
  :is(:root[titlepreface*="᠎"], :root:not([titlepreface*="᠎"]):has( #sidebar-main > *:not([hidden]):not([expanded]) ):has( #sidebar-box[hidden] ) ){
    
    @media (-moz-bool-pref: "shyfox.position.navbar") { --bmbr-left-gap: var(--left-gap); }
    
    #PersonalToolbar{
      --bmbr-hover-top: calc( var(--margin-on-top) + var(--left-nvbr-hgt) + var(--margin) + var(--bmbr-left-gap) );
      
      --bmbr-hover-col: var(--tb-col);
      --bmbr-hover-txt: var(--tb-txt);
      
      --bmbr-hover-brs: var(--big-rounding);
      --bmbr-hover-brw: var(--br-wdt);
      --bmbr-hover-brt: var(--br-style);
      --bmbr-hover-brc: var(--br-col);
    }
    
    #PersonalToolbar::before{
      content: ""; position: absolute;
      -moz-window-dragging: drag;
      z-index: -999;
      right: calc( 0px - var(--panel-hidden-hitbox) );
      bottom: calc( 0px - var(--br-wdt) );
      width: 500%; height: 500%;
      background: var(--debug-col);
    }
  }
  
  :root[titlepreface*="᠎"]{
    #PersonalToolbar{
      left: var(--hidden-left) !important;
    }
  }
  
  :root:not([titlepreface*="᠎"]):has( #sidebar-main > *:not([hidden]):not([expanded]) ):has( #sidebar-box[hidden] ) {
    #PersonalToolbar{
      left: var(--semi-hidden-left) !important;
    }
  }
}

/* 

##############################################################################################################################

 A P P E A R A N C E : G A P L E S S

*/

@media (-moz-bool-pref: "shyfox.appearance.leftbar.gapless") {
  :is(:root[titlepreface*="᠎"], :root:not([titlepreface*="᠎"]):has( #sidebar-main > *:not([hidden]):not([expanded]) ):has( #sidebar-box[hidden] ) ){
    & { --left-gap: 0px }
  }
  
  :root:not([titlepreface*="᠎"]):has( #sidebar-main > *:not([hidden]):not([expanded]) ):has( #sidebar-box[hidden] ) {
  @media (-moz-bool-pref: "shyfox.position.navbar") and (-moz-bool-pref: "shyfox.position.bookmarkbar") {
    #nav-bar{
      --nvbr-hover-brs: var(--big-rounding) var(--big-rounding) 0px 0px;
      --nvbr-hover-brw: var(--br-wdt) var(--br-wdt) 0px var(--br-wdt);
    }
    #PersonalToolbar{
      --bmbr-hover-brs: 0px 0px var(--big-rounding) var(--big-rounding);
      --bmbr-hover-brw: 0px var(--br-wdt) var(--br-wdt) var(--br-wdt);
    }
  } }
}


/* 

##############################################################################################################################

 S E M I   H I D D E N   M A G I C   Z O N E

*/

:root:not([titlepreface*="᠎"]):has( #sidebar-main > *:not([hidden]):not([expanded]) ):has( #sidebar-box[hidden] ) {
  
  
  @media (-moz-bool-pref: "shyfox.position.navbar") and (-moz-bool-pref: "shyfox.position.extbutton") and (-moz-bool-pref: "shyfox.position.menubutton") {&:has(
    #nav-bar-customization-target:hover #unified-extensions-button:not(:hover),
    #nav-bar-customization-target *:not(#unified-extensions-button, #firefox-view-button)[open]
  ) {
    #nav-bar{ --toolbarbutton-icon-fill: var(--nvbr-hover-txt) !important;
      left: var(--hover-left) !important; top: var(--nvbr-hover-top) !important;
      background: var(--nvbr-hover-col) !important; color: var(--nvbr-hover-txt) !important;
      border-radius: var(--nvbr-hover-brs) !important; border-width: var(--nvbr-hover-brw) !important;
      border-style: var(--nvbr-hover-brt) !important; border-color: var(--nvbr-hover-brc) !important;
    }
    @media (-moz-bool-pref: "shyfox.position.bookmarkbar") { #PersonalToolbar{
      left: var(--hover-left) !important; top: var(--bmbr-hover-top) !important;
      background: var(--bmbr-hover-col) !important; color: var(--bmbr-hover-txt) !important;
      border-radius: var(--bmbr-hover-brs) !important; border-width: var(--bmbr-hover-brw) !important;
      border-style: var(--bmbr-hover-brt) !important; border-color: var(--bmbr-hover-brc) !important;
    } }
  } }
  
  @media (-moz-bool-pref: "shyfox.position.navbar") and ( not (-moz-bool-pref: "shyfox.position.extbutton") ) and (-moz-bool-pref: "shyfox.position.menubutton") {&:has(
    #nav-bar-customization-target:hover,
    #nav-bar-customization-target *:not(#firefox-view-button)[open]
  ) {
    #nav-bar{ --toolbarbutton-icon-fill: var(--nvbr-hover-txt) !important;
      left: var(--hover-left) !important; top: var(--nvbr-hover-top) !important;
      background: var(--nvbr-hover-col) !important; color: var(--nvbr-hover-txt) !important;
      border-radius: var(--nvbr-hover-brs) !important; border-width: var(--nvbr-hover-brw) !important;
      border-style: var(--nvbr-hover-brt) !important; border-color: var(--nvbr-hover-brc) !important;
    }
    @media (-moz-bool-pref: "shyfox.position.bookmarkbar") { #PersonalToolbar{
      left: var(--hover-left) !important; top: var(--bmbr-hover-top) !important;
      background: var(--bmbr-hover-col) !important; color: var(--bmbr-hover-txt) !important;
      border-radius: var(--bmbr-hover-brs) !important; border-width: var(--bmbr-hover-brw) !important;
      border-style: var(--bmbr-hover-brt) !important; border-color: var(--bmbr-hover-brc) !important;
    } }
  } }
  
  @media (-moz-bool-pref: "shyfox.position.navbar") and (-moz-bool-pref: "shyfox.position.extbutton") and ( not (-moz-bool-pref: "shyfox.position.menubutton") ) {&:has(
    #nav-bar-customization-target:hover #unified-extensions-button:not(:hover),
    #nav-bar-customization-target *:not(#unified-extensions-button, #firefox-view-button)[open],
    #PanelUI-button:hover, #PanelUI-menu-button[open]
  ) {
    #nav-bar{ --toolbarbutton-icon-fill: var(--nvbr-hover-txt) !important;
      left: var(--hover-left) !important; top: var(--nvbr-hover-top) !important;
      background: var(--nvbr-hover-col) !important; color: var(--nvbr-hover-txt) !important;
      border-radius: var(--nvbr-hover-brs) !important; border-width: var(--nvbr-hover-brw) !important;
      border-style: var(--nvbr-hover-brt) !important; border-color: var(--nvbr-hover-brc) !important;
    }
    @media (-moz-bool-pref: "shyfox.position.bookmarkbar") { #PersonalToolbar{
      left: var(--hover-left) !important; top: var(--bmbr-hover-top) !important;
      background: var(--bmbr-hover-col) !important; color: var(--bmbr-hover-txt) !important;
      border-radius: var(--bmbr-hover-brs) !important; border-width: var(--bmbr-hover-brw) !important;
      border-style: var(--bmbr-hover-brt) !important; border-color: var(--bmbr-hover-brc) !important;
    } }
  } }
  
  @media (-moz-bool-pref: "shyfox.position.navbar") and ( not (-moz-bool-pref: "shyfox.position.extbutton") ) and ( not (-moz-bool-pref: "shyfox.position.menubutton") ) {&:has(
    #nav-bar-customization-target:hover,
    #nav-bar-customization-target *:not(#firefox-view-button)[open],
    #PanelUI-button:hover, #PanelUI-menu-button[open]
  ) {
    #nav-bar{ --toolbarbutton-icon-fill: var(--nvbr-hover-txt) !important;
      left: var(--hover-left) !important; top: var(--nvbr-hover-top) !important;
      background: var(--nvbr-hover-col) !important; color: var(--nvbr-hover-txt) !important;
      border-radius: var(--nvbr-hover-brs) !important; border-width: var(--nvbr-hover-brw) !important;
      border-style: var(--nvbr-hover-brt) !important; border-color: var(--nvbr-hover-brc) !important;
    }
    @media (-moz-bool-pref: "shyfox.position.bookmarkbar") { #PersonalToolbar{
      left: var(--hover-left) !important; top: var(--bmbr-hover-top) !important;
      background: var(--bmbr-hover-col) !important; color: var(--bmbr-hover-txt) !important;
      border-radius: var(--bmbr-hover-brs) !important; border-width: var(--bmbr-hover-brw) !important;
      border-style: var(--bmbr-hover-brt) !important; border-color: var(--bmbr-hover-brc) !important;
    } }
  } }
  
  @media (-moz-bool-pref: "shyfox.position.bookmarkbar") {&:has(
    #PersonalToolbar:hover, #PersonalToolbar *[open]
  ) {
    @media (-moz-bool-pref: "shyfox.position.navbar") { #nav-bar{ 
      --toolbarbutton-icon-fill: var(--nvbr-hover-txt) !important;
      left: var(--hover-left) !important; top: var(--nvbr-hover-top) !important;
      background: var(--nvbr-hover-col) !important; color: var(--nvbr-hover-txt) !important;
      border-radius: var(--nvbr-hover-brs) !important; border-width: var(--nvbr-hover-brw) !important;
      border-style: var(--nvbr-hover-brt) !important; border-color: var(--nvbr-hover-brc) !important;
    } }
    #PersonalToolbar{
      left: var(--hover-left) !important; top: var(--bmbr-hover-top) !important;
      background: var(--bmbr-hover-col) !important; color: var(--bmbr-hover-txt) !important;
      border-radius: var(--bmbr-hover-brs) !important; border-width: var(--bmbr-hover-brw) !important;
      border-style: var(--bmbr-hover-brt) !important; border-color: var(--bmbr-hover-brc) !important;
    }
  } }
  
}
